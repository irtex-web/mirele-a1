{# Import of all necessary dependencies to generate the template #}
{% import 'Compound/editor/modal/insert_template.twig' as modal_insert_template %}
{% import 'Compound/editor/modal/insert_component.twig' as modal_insert_component %}
{% import 'Compound/editor/modal/edit_props.twig' as modal_edit_props %}
{% import 'Compound/editor/modal/edit_template.twig' as modal_edit_template %}
{% import 'Compound/editor/postbox/meta.twig' as postbox_meta %}
{% import 'Compound/editor/panel/tools.twig' as panel_tools %}
{% import 'Compound/editor/spinner/editor_preparation.twig' as editor_preparation %}
{% import 'Compound/editor/message/editor_error_preparation.twig' as editor_error_preparation %}

{# Generation of universal package data for valid rendering #}
{% set data_package = {
    page: page,
    templates: store.templates,
    components: store.components,
    families: store.getFamilies,
} %}

{# We generate the instances of all modal windows with which user interaction will take place. #}
{# Without calling the Render macro, #}
{# the modal windows will not be drawn on the page and will not receive any interaction. #}
{{ modal_insert_template.render(data_package) }}
{{ modal_insert_component.render(data_package) }}
{{ modal_edit_props.render(data_package) }}
{{ modal_edit_template.render(data_package) }}

{% block meta %} {% endblock %}

<div class="wrap">

    <h1>Compound Block</h1>

    <hr class="wp-header-end"/>

    <div id="poststuff">
        <div id="post-body" class="metabox-holder columns-2">

            <div id="post-body-content" style="position: relative;">

                <div class="root-blocks">

                    <div class="wp-mrl-box" id="compound-editor-body" data-behavior="" data-component="editor">

                        <div class="hidden" data-component="body" data-namespace="editor">

                            <h2 class="wp-mrl-header">
                                <span>Compound Page Editor</span>
                            </h2>

                            <div class="wp-mrl-tools">

                                {{ panel_tools.render({

                                    left: [

                                        {
                                            href: "#TB_inline?width=600&height=700&inlineId=modal_insert_template",
                                            icon: "dashicons-plus",
                                            modal: {
                                                title: "Insert template"
                                            }
                                        },

                                        {
                                            href: "#TB_inline?width=800&height=800&inlineId=modal_edit_template",
                                            icon: "dashicons-welcome-write-blog",
                                            modal: {
                                                title: "Edit page"
                                            }
                                        },

                                        {
                                            href: page.guid,
                                            icon: "dashicons-external",
                                            attr: {
                                                target: '_blank',
                                                rel: 'noopener noreferrer'
                                            }
                                        }

                                    ],

                                    right: []

                                }) }}

                            </div>

                            <div class="inner" data-behavior="sortable" data-namespace="editor">

                                <div class="__compound_field_grid" :data-template="template.name" :data-id="template.id"
                                     :data-page-id="template.page" v-for="template in markup" v-if="markup"
                                     data-component="field" data-namespace="editor">

                                    <div class="grid-container __compound_field_body" data-component="field-body" data-namespace="editor">

                                        <div :class="__metaFieldClass__(field.meta)"
                                             v-for="(field, name) in template.fields">

                                            <div v-if="field.tags">
                                                <div v-for="tag in field.tags">
                                                    <div v-if="tag.tag == 'component'" class="wp-mrl-component left"
                                                         @click="editProps({field: name, component: tag.attributes.name, template: template.id})">
                                                        <h5 class="margin-0 padding-0">{tag.attributes.name}</h5>
                                                        <small>
                                                            Component
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>

                                            <div v-else>
                                                <div :data-field-name="name">
                                                    <div class="wp-mrl-insert"
                                                         @click="insertComponent({field: name, template: template.id})">
                                                        <span class="dashicons dashicons-plus"></span>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>

                                    </div>

                                    <div class="__compound_field_control center">

                                        <div class="__compound_field_control_action padding-2" data-action="" data-namespace="editor" title="Click to make a copy">
                                            <span class="dashicons dashicons-admin-page"></span>
                                        </div>

                                        <div class="__compound_field_control_action_remove padding-2" data-action="remove" data-namespace="editor" title="Press and hold to move block" @click="__menu_action_remove_template({template: template.id})">
                                            <span class="dashicons dashicons-trash"></span>
                                        </div>

                                        <div class="__compound_field_control_action_move padding-2" data-action="move" data-namespace="editor" title="Press and hold to move block" @mousedown="__move_enabled()">
                                            <span class="dashicons dashicons-move"></span>
                                        </div>

                                    </div>

                                </div>

                            </div>

                            <div class="wp-mrl-trash hidden" data-behavior="droppable" data-namespace="editor"
                                 data-role="trash">
                                <span class="dashicons dashicons-trash"></span>
                            </div>

                            <div class="wp-mrl-add" @click="insertTemplate({})">
                                <span class="dashicons dashicons-plus"></span>
                            </div>

                        </div>

                        <!-- Spinner -->
                        <div class="main" data-component="spinner" data-namespace="editor">
                            {{ editor_preparation.render() }}
                        </div>

                        <!-- Error -->
                        {{ editor_error_preparation.render({}) }}

                    </div>

                </div>
            </div>

            {{ postbox_meta.render({page: page}) }}

        </div>
        <br class="clear"/>
    </div>

</div>
